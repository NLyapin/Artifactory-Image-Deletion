# Docker Image Deletion Experiment

Этот репозиторий предназначен для тестирования поведения Artifactory при удалении цепочки связанных Docker-образов.  
Сценарий демонстрирует, что слои образов не удаляются из Artifactory, пока на них существуют ссылки (другие образы или теги).

## Состав репозитория

- `deletion-experiment.sh` — основной скрипт:
  1. Создаёт цепочку из `N` образов, где каждый следующий зависит от предыдущего (`FROM`).
  2. Публикует образы в Artifactory.
  3. Удаляет все образы, кроме базового (`deletion-image-0`), через JFrog CLI.
  4. Запускает контейнер из оставшегося образа для проверки доступности слоёв.

- `old-images-10d.json` — AQL-запрос для поиска образов/слоёв в Artifactory, не загружавшихся более 10 дней.

## Требования

- Docker (с поддержкой BuildKit желательно).
- JFrog CLI, запущенный в контейнере (например, `jf-cli`).
- Доступ к вашему Artifactory (URL, `server-id`, логин/пароль или API-ключ).
- Подготовленные переменные окружения:
  ```bash
  export REPO=example
  export SERVER_ID=example
  ```

## Запуск эксперимента

1.  Склонировать репозиторий:
    
    ```bash
    git clone <repo-url>
    cd <repo-name>
    ```
    
2.  Запустить эксперимент:
    
    ```bash
    bash deletion-experiment.sh
    ```
    
3.  В процессе будут собраны и запушены образы:
    
    ```bash
    $REPO/deletion-image-0
    $REPO/deletion-image-1
    ...
    $REPO/deletion-image-N
    ```
    
4.  После удаления через JFrog CLI останется только `deletion-image-0`, но он продолжит работать, так как слои, на которые он ссылается, не были удалены.
    

## Проверка

-   Запустить контейнер:
    
    ```bash
    docker run -it $REPO/deletion-image-0 sh
    ```
    
-   Проверить слои:
    
    ```bash
    docker history $REPO/deletion-image-0
    ```
    
-   Убедиться, что контейнер успешно стартует, даже если родительские образы были удалены из Artifactory.
    

## Поиск старых образов

Файл `old-images-10d.json` содержит AQL-запрос для поиска образов/слоёв, которые не скачивались более 10 дней.  
Пример запуска:

```bash
jf rt s --spec=old-images-10d.json \
  --server-id=$SERVER_ID
```

## Вывод

Эксперимент подтверждает, что **удаление тегов/образов в Artifactory не приводит к удалению общих слоёв, пока на них остаются ссылки**. Это полезно при настройке политики ретенции.